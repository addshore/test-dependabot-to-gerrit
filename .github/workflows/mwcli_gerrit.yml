name: Fetch from Gerrit, Run stuff, Report back

on:
  workflow_dispatch:
    inputs:
      fetch-repo:
        description: 'repo to fetch'
        required: true
      fetch-ref:
        description: 'ref to fetch from repo'
        required: true
      run-scripts:
        description: 'files to run, JSON list. Example: `["echo foo","echo bar"]`'
        required: true
      report-change:
        description: 'change to report back to. Example: `456323,2`'
        required: true

jobs:
  run:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
          run: ${{ fromJson(github.event.inputs.run-scripts)}}
    steps:
      - name: Fetch Code
        run: |
          git init . && git fetch "${{ github.event.inputs.fetch-repo }}" ${{ github.event.inputs.fetch-ref }} && git checkout FETCH_HEAD
      - name: Run Script
        run: |
          set -e
          ${{ matrix.run }}
      - name: Create job failure file
        if: ${{ !success() }}
        run: echo "true" > job-failure
      - name: Record job failure file
        if: ${{ !success() }}
        uses: actions/upload-artifact@v2
        with:
          name: job-failure
          path: job-failure

  report-back:
    if: always()
    needs: [ run ]
    runs-on: ubuntu-latest
    steps:
      - name: Setup Gerrit SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.ADDBOT_GERRIT_SSH }}
          known_hosts: ${{ secrets.GERRIT_KNOWN_HOST }}
      - name: Fetch job failure file
        uses: actions/download-artifact@v2
        continue-on-error: true
        with:
          name: job-failure
      - name: Report to Gerrit
        run: |
          set +e
          # Figure out some things
          MSG_PRE=$((test -f job-failure && echo "Github Action Failed") || echo "Github Action Success")
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          # Build a review https://gerrit-review.googlesource.com/Documentation/rest-api-changes.html#review-input
          REVIEW={}
          REVIEW=$(echo $REVIEW | jq --arg message "${MSG_PRE}: ${RUN_URL}" '. + {message: $message}')
          echo $REVIEW
          # Submit a review https://gerrit-review.googlesource.com/Documentation/cmd-review.html
          echo $REVIEW | ssh -p 29418 addbot@gerrit.wikimedia.org gerrit review --json ${{ github.event.inputs.report-change }}
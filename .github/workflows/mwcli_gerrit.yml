name: Fetch from Gerrit and run File

on:
  workflow_dispatch:
    inputs:
      fetch-repo:
        description: 'repo to fetch'
        required: true
      fetch-ref:
        description: 'ref to fetch from repo'
        required: true
      run-scripts:
        description: 'files to run, JSON list. Example: `["echo foo","echo bar"]`'
        required: true
      report-change:
        description: 'change to report back to. Example: `456323,2`'
        required: true

jobs:
  run:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
          run: ${{ fromJson(github.event.inputs.run-scripts)}}
    steps:
      - name: Fetch Code
        run: |
          git init . && git fetch "${{ github.event.inputs.fetch-repo }}" ${{ github.event.inputs.fetch-ref }} && git checkout FETCH_HEAD
      - name: Run Script
        run: |
          set -e
          ${{ matrix.run }}

  report-back:
    if: always()
    needs: [ run ]
    runs-on: ubuntu-latest
    steps:
      - name: Setup Gerrit SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.ADDBOT_GERRIT_SSH }}
          known_hosts: ${{ secrets.GERRIT_KNOWN_HOST }}
      - name: Report (Success)
        if: success()
        run: |
          ssh -p 29418 addbot@gerrit.wikimedia.org gerrit review --message "✔️ Github Action Success ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_NUMBER}" ${{ github.event.inputs.report-change }}
      - name: Report (Failure)
        if: ${{ !success() }}
        run: |
          ssh -p 29418 addbot@gerrit.wikimedia.org gerrit review --message "❌ Github Action Failure ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_NUMBER}" ${{ github.event.inputs.report-change }}